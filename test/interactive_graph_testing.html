<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Problem Visualization</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100%;
            background-color: #F5F5F5;
        }
        .container {
            display: flex;
            height: 100%;
            max-height: 100vh;
        }
        .left-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }
        .right-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .problem-statement, .problem-understanding {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .highlight-number-1 {
            background-color: rgba(255, 99, 71, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-2 {
            background-color: rgba(135, 206, 250, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-3 {
            background-color: rgba(144, 238, 144, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-4 {
            background-color: rgba(255, 165, 0, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-5 {
            background-color: rgba(221, 160, 221, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-6 {
            background-color: rgba(255, 215, 0, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-7 {
            background-color: rgba(70, 130, 180, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-8 {
            background-color: rgba(34, 139, 34, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-9 {
            background-color: rgba(255, 192, 203, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .highlight-number-10 {
            background-color: rgba(220, 20, 60, 0.5);
            padding: 2px 6px;
            border-radius: 5px;
            color: black;
        }
        .debugger-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            color: white;
            transition: background-color 0.2s;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #playPauseBtn {
            background-color: #2ecc71;
        }
        #stopBtn {
            background-color: #e74c3c;
        }
        #prevBtn, #nextBtn {
            background-color: #3498db;
        }
        .graph-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            background-color: white;
        }
        #math-graph {
            width: 100%;
            height: 100%;
        }
        #step-iframe {
            height: 150px;
            border: none;
            border-top: 1px solid #ddd;
            width: 100%;
        }
        .node {
            cursor: move;
            transition: transform 0.2s;
        }
        .node:hover {
            filter: brightness(0.95);
        }
        .node.highlight {
            filter: brightness(1.1);
        }
        .connection {
            transition: stroke-width 0.2s;
        }
        .connection.highlight {
            stroke-width: 5px;
        }
        .drag-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #666;
            text-align: right;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border-radius: 5px;
        }
        .final-answer {
            background-color: #d4edda;
            border-left: 3px solid #28a745;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 4px;
        }
        .step-content {
            padding: 15px;
            background-color: #FFF3CD;
            border-left: 3px solid #FFC107;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="problem-statement">
                <div class="section-title">Problem Statement</div>
                <p>
                    On <span id="fact1" class="highlight-number-1">Mondays, Wednesdays, and Fridays</span>, college student Kimo has <span id="fact2" class="highlight-number-2">three 1-hour classes</span> each day. On <span id="fact3" class="highlight-number-3">Tuesdays and Thursdays</span>, he has <span id="fact4" class="highlight-number-4">two 2-hour classes</span> each day. In one semester, there are <span id="fact5" class="highlight-number-5">16 weeks</span> of school. In one semester, how many hours does Kimo spend attending classes?
                </p>
            </div>
            <div class="problem-understanding">
                <div class="section-title">Problem Summary</div>
                <ul>
                    <li><span class="highlight-number-1">Mondays, Wednesdays, and Fridays</span>: 3 days per week</li>
                    <li><span class="highlight-number-2">Three 1-hour classes</span> on each of these days</li>
                    <li><span class="highlight-number-3">Tuesdays and Thursdays</span>: 2 days per week</li>
                    <li><span class="highlight-number-4">Two 2-hour classes</span> on each of these days</li>
                    <li><span class="highlight-number-5">16 weeks</span> in one semester</li>
                </ul>
                <div><strong>What we need to find:</strong> Total hours Kimo spends attending classes in one semester</div>
            </div>
        </div>
        <div class="right-panel">
            <div class="debugger-controls">
                <button id="playPauseBtn" class="btn">Play</button>
                <button id="stopBtn" class="btn">Stop</button>
                <button id="prevBtn" class="btn">Previous Step</button>
                <button id="nextBtn" class="btn">Next Step</button>
            </div>
            <div class="graph-container" id="graph-container">
                <svg id="math-graph" width="100%" height="100%" viewBox="0 0 800 480">
                    <defs>
                        <marker id="arrowhead" markerWidth="8" markerHeight="5" refX="7" refY="2.5" orient="auto">
                            <polygon points="0 0, 8 2.5, 0 5" fill="black" />
                        </marker>
                    </defs>
                </svg>
                <div class="drag-indicator">üí° Drag nodes to rearrange<br>üîç Click nodes for details</div>
            </div>
            <iframe id="step-iframe" frameborder="0"></iframe>
        </div>
    </div>

    <script>
        // Problem data with steps
        const problemData = {
            totalSteps: 7,
            getSteps: function() {
                return [
                    {
                        explanation: "First, let's calculate how many hours Kimo spends in class on Mondays, Wednesdays, and Fridays combined in one week.",
                        calculation: "3 days √ó 3 hours = 9 hours",
                        nodes: [
                            {
                                id: "mwf-hours",
                                position: { x: 200, y: 150 },
                                label: "MWF Hours/Week",
                                value: "9 hours",
                                calc: "(3 days √ó 3 hours)",
                                color: "rgba(255, 99, 71, 0.5)",
                                isNew: true
                            }
                        ],
                        connections: []
                    },
                    {
                        explanation: "Next, let's calculate how many hours Kimo spends in class on Tuesdays and Thursdays combined in one week.",
                        calculation: "2 days √ó 4 hours = 8 hours",
                        nodes: [
                            {
                                id: "mwf-hours",
                                position: { x: 200, y: 150 },
                                label: "MWF Hours/Week",
                                value: "9 hours",
                                calc: "(3 days √ó 3 hours)",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                id: "tth-hours",
                                position: { x: 200, y: 280 },
                                label: "TTh Hours/Week",
                                value: "8 hours",
                                calc: "(2 days √ó 4 hours)",
                                color: "rgba(135, 206, 250, 0.5)",
                                isNew: true
                            }
                        ],
                        connections: []
                    },
                    {
                        explanation: "Now, let's calculate the total hours Kimo spends in class per week by adding the hours from MWF and TTh.",
                        calculation: "9 hours + 8 hours = 17 hours per week",
                        nodes: [
                            {
                                id: "mwf-hours",
                                position: { x: 200, y: 150 },
                                label: "MWF Hours/Week",
                                value: "9 hours",
                                calc: "(3 days √ó 3 hours)",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                id: "tth-hours",
                                position: { x: 200, y: 280 },
                                label: "TTh Hours/Week",
                                value: "8 hours",
                                calc: "(2 days √ó 4 hours)",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                id: "total-hours-week",
                                position: { x: 400, y: 215 },
                                label: "Hours per Week",
                                value: "17 hours",
                                calc: "(9 hours + 8 hours)",
                                color: "rgba(144, 238, 144, 0.5)",
                                isNew: true
                            }
                        ],
                        connections: [
                            {
                                from: "mwf-hours",
                                to: "total-hours-week",
                                label: "9",
                                operation: "+",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                from: "tth-hours",
                                to: "total-hours-week",
                                label: "8",
                                operation: "+",
                                color: "rgba(135, 206, 250, 0.5)"
                            }
                        ]
                    },
                    {
                        explanation: "To find the total hours in one semester, we multiply the weekly hours by the number of weeks in a semester.",
                        calculation: "17 hours per week √ó 16 weeks = 272 hours",
                        nodes: [
                            {
                                id: "mwf-hours",
                                position: { x: 200, y: 150 },
                                label: "MWF Hours/Week",
                                value: "9 hours",
                                calc: "(3 days √ó 3 hours)",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                id: "tth-hours",
                                position: { x: 200, y: 280 },
                                label: "TTh Hours/Week",
                                value: "8 hours",
                                calc: "(2 days √ó 4 hours)",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                id: "total-hours-week",
                                position: { x: 400, y: 215 },
                                label: "Hours per Week",
                                value: "17 hours",
                                calc: "(9 hours + 8 hours)",
                                color: "rgba(144, 238, 144, 0.5)"
                            },
                            {
                                id: "semester-hours",
                                position: { x: 600, y: 215 },
                                label: "Semester Hours",
                                value: "272 hours",
                                calc: "(17 hours √ó 16 weeks)",
                                color: "rgba(255, 165, 0, 0.5)",
                                isNew: true
                            }
                        ],
                        connections: [
                            {
                                from: "mwf-hours",
                                to: "total-hours-week",
                                label: "9",
                                operation: "+",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                from: "tth-hours",
                                to: "total-hours-week",
                                label: "8",
                                operation: "+",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                from: "total-hours-week",
                                to: "semester-hours",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            }
                        ]
                    },
                    {
                        explanation: "Let's verify our calculation by finding the total hours for MWF classes in one semester.",
                        calculation: "9 hours per week √ó 16 weeks = 144 hours",
                        nodes: [
                            {
                                id: "mwf-hours",
                                position: { x: 200, y: 150 },
                                label: "MWF Hours/Week",
                                value: "9 hours",
                                calc: "(3 days √ó 3 hours)",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                id: "tth-hours",
                                position: { x: 200, y: 280 },
                                label: "TTh Hours/Week",
                                value: "8 hours",
                                calc: "(2 days √ó 4 hours)",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                id: "total-hours-week",
                                position: { x: 400, y: 215 },
                                label: "Hours per Week",
                                value: "17 hours",
                                calc: "(9 hours + 8 hours)",
                                color: "rgba(144, 238, 144, 0.5)"
                            },
                            {
                                id: "semester-hours",
                                position: { x: 600, y: 215 },
                                label: "Semester Hours",
                                value: "272 hours",
                                calc: "(17 hours √ó 16 weeks)",
                                color: "rgba(255, 165, 0, 0.5)"
                            },
                            {
                                id: "mwf-semester",
                                position: { x: 400, y: 100 },
                                label: "MWF Semester Hours",
                                value: "144 hours",
                                calc: "(9 hours √ó 16 weeks)",
                                color: "rgba(255, 215, 0, 0.5)",
                                isNew: true
                            }
                        ],
                        connections: [
                            {
                                from: "mwf-hours",
                                to: "total-hours-week",
                                label: "9",
                                operation: "+",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                from: "tth-hours",
                                to: "total-hours-week",
                                label: "8",
                                operation: "+",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                from: "total-hours-week",
                                to: "semester-hours",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            },
                            {
                                from: "mwf-hours",
                                to: "mwf-semester",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            }
                        ]
                    },
                    {
                        explanation: "Now, let's calculate the total hours for TTh classes in one semester.",
                        calculation: "8 hours per week √ó 16 weeks = 128 hours",
                        nodes: [
                            {
                                id: "mwf-hours",
                                position: { x: 200, y: 150 },
                                label: "MWF Hours/Week",
                                value: "9 hours",
                                calc: "(3 days √ó 3 hours)",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                id: "tth-hours",
                                position: { x: 200, y: 280 },
                                label: "TTh Hours/Week",
                                value: "8 hours",
                                calc: "(2 days √ó 4 hours)",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                id: "total-hours-week",
                                position: { x: 400, y: 215 },
                                label: "Hours per Week",
                                value: "17 hours",
                                calc: "(9 hours + 8 hours)",
                                color: "rgba(144, 238, 144, 0.5)"
                            },
                            {
                                id: "semester-hours",
                                position: { x: 600, y: 215 },
                                label: "Semester Hours",
                                value: "272 hours",
                                calc: "(17 hours √ó 16 weeks)",
                                color: "rgba(255, 165, 0, 0.5)"
                            },
                            {
                                id: "mwf-semester",
                                position: { x: 400, y: 100 },
                                label: "MWF Semester Hours",
                                value: "144 hours",
                                calc: "(9 hours √ó 16 weeks)",
                                color: "rgba(255, 215, 0, 0.5)"
                            },
                            {
                                id: "tth-semester",
                                position: { x: 400, y: 330 },
                                label: "TTh Semester Hours",
                                value: "128 hours",
                                calc: "(8 hours √ó 16 weeks)",
                                color: "rgba(70, 130, 180, 0.5)",
                                isNew: true
                            }
                        ],
                        connections: [
                            {
                                from: "mwf-hours",
                                to: "total-hours-week",
                                label: "9",
                                operation: "+",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                from: "tth-hours",
                                to: "total-hours-week",
                                label: "8",
                                operation: "+",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                from: "total-hours-week",
                                to: "semester-hours",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            },
                            {
                                from: "mwf-hours",
                                to: "mwf-semester",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            },
                            {
                                from: "tth-hours",
                                to: "tth-semester",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            }
                        ]
                    },
                    {
                        explanation: "Let's verify our answer by adding the semester hours for MWF and TTh classes.",
                        calculation: "144 hours + 128 hours = 272 hours",
                        nodes: [
                            {
                                id: "mwf-hours",
                                position: { x: 200, y: 150 },
                                label: "MWF Hours/Week",
                                value: "9 hours",
                                calc: "(3 days √ó 3 hours)",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                id: "tth-hours",
                                position: { x: 200, y: 280 },
                                label: "TTh Hours/Week",
                                value: "8 hours",
                                calc: "(2 days √ó 4 hours)",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                id: "total-hours-week",
                                position: { x: 400, y: 215 },
                                label: "Hours per Week",
                                value: "17 hours",
                                calc: "(9 hours + 8 hours)",
                                color: "rgba(144, 238, 144, 0.5)"
                            },
                            {
                                id: "semester-hours",
                                position: { x: 600, y: 215 },
                                label: "Semester Hours",
                                value: "272 hours",
                                calc: "(17 hours √ó 16 weeks)",
                                color: "rgba(255, 165, 0, 0.5)"
                            },
                            {
                                id: "mwf-semester",
                                position: { x: 400, y: 100 },
                                label: "MWF Semester Hours",
                                value: "144 hours",
                                calc: "(9 hours √ó 16 weeks)",
                                color: "rgba(255, 215, 0, 0.5)"
                            },
                            {
                                id: "tth-semester",
                                position: { x: 400, y: 330 },
                                label: "TTh Semester Hours",
                                value: "128 hours",
                                calc: "(8 hours √ó 16 weeks)",
                                color: "rgba(70, 130, 180, 0.5)"
                            },
                            {
                                id: "verification",
                                position: { x: 600, y: 330 },
                                label: "Verification",
                                value: "272 hours",
                                calc: "(144 hours + 128 hours)",
                                color: "rgba(34, 139, 34, 0.5)",
                                isNew: true
                            }
                        ],
                        connections: [
                            {
                                from: "mwf-hours",
                                to: "total-hours-week",
                                label: "9",
                                operation: "+",
                                color: "rgba(255, 99, 71, 0.5)"
                            },
                            {
                                from: "tth-hours",
                                to: "total-hours-week",
                                label: "8",
                                operation: "+",
                                color: "rgba(135, 206, 250, 0.5)"
                            },
                            {
                                from: "total-hours-week",
                                to: "semester-hours",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            },
                            {
                                from: "mwf-hours",
                                to: "mwf-semester",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            },
                            {
                                from: "tth-hours",
                                to: "tth-semester",
                                label: "16",
                                operation: "√ó",
                                color: "rgba(221, 160, 221, 0.5)"
                            },
                            {
                                from: "mwf-semester",
                                to: "verification",
                                label: "144",
                                operation: "+",
                                color: "rgba(255, 215, 0, 0.5)"
                            },
                            {
                                from: "tth-semester",
                                to: "verification",
                                label: "128",
                                operation: "+",
                                color: "rgba(70, 130, 180, 0.5)"
                            }
                        ]
                    }
                ];
            }
        };

        // DOM elements
        const svg = document.getElementById('math-graph');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const stepIframe = document.getElementById('step-iframe');

        // State variables
        let currentStep = 1;
        let isPlaying = false;
        let playInterval = null;
        let nodePositions = {};
        let draggedNode = null;
        let dragOffset = { x: 0, y: 0 };

        // Initialize the visualization
        function init() {
            updateButtons();
            renderStep(currentStep);
            setupEventListeners();
        }

        // Update button states based on current step
        function updateButtons() {
            prevBtn.disabled = currentStep === 1;
            nextBtn.disabled = currentStep === problemData.totalSteps;
            playPauseBtn.textContent = isPlaying ? 'Pause' : 'Play';
        }

        // Render the current step
        function renderStep(stepIndex) {
            // Clear the SVG
            while (svg.lastChild) {
                if (svg.lastChild.tagName === 'defs') break;
                svg.removeChild(svg.lastChild);
            }

            // Get the step data
            const steps = problemData.getSteps();
            const step = steps[stepIndex - 1];

            // Render nodes
            step.nodes.forEach(node => {
                // Use stored position if available, otherwise use the default
                if (!nodePositions[node.id]) {
                    nodePositions[node.id] = { x: node.position.x, y: node.position.y };
                }
                
                const position = nodePositions[node.id];
                
                // Create node group
                const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                nodeGroup.setAttribute('class', 'node');
                nodeGroup.setAttribute('id', node.id);
                nodeGroup.setAttribute('data-is-new', node.isNew ? 'true' : 'false');
                
                // Create rectangle
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', position.x - 60);
                rect.setAttribute('y', position.y - 35);
                rect.setAttribute('width', '120');
                rect.setAttribute('height', '70');
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', node.color);
                rect.setAttribute('fill-opacity', '0.1');
                rect.setAttribute('stroke', node.color.replace('0.5', '1'));
                rect.setAttribute('stroke-width', '2');
                
                // Create label text
                const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelText.setAttribute('x', position.x);
                labelText.setAttribute('y', position.y - 15);
                labelText.setAttribute('text-anchor', 'middle');
                labelText.setAttribute('dominant-baseline', 'central');
                labelText.setAttribute('font-size', '14px');
                labelText.setAttribute('font-weight', 'bold');
                labelText.setAttribute('fill', '#1e293b');
                labelText.textContent = node.label;
                
                // Create value text
                const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                valueText.setAttribute('x', position.x);
                valueText.setAttribute('y', position.y + 5);
                valueText.setAttribute('text-anchor', 'middle');
                valueText.setAttribute('dominant-baseline', 'central');
                valueText.setAttribute('font-size', '16px');
                valueText.setAttribute('font-weight', 'bold');
                valueText.setAttribute('fill', '#059669');
                valueText.textContent = node.value;
                
                // Create calculation text
                const calcText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                calcText.setAttribute('x', position.x);
                calcText.setAttribute('y', position.y + 20);
                calcText.setAttribute('text-anchor', 'middle');
                calcText.setAttribute('dominant-baseline', 'central');
                calcText.setAttribute('font-size', '12px');
                calcText.setAttribute('fill', '#6b7280');
                calcText.textContent = node.calc;
                
                // Add elements to the group
                nodeGroup.appendChild(rect);
                nodeGroup.appendChild(labelText);
                nodeGroup.appendChild(valueText);
                nodeGroup.appendChild(calcText);
                
                // Add animation for new nodes
                if (node.isNew) {
                    nodeGroup.style.transform = 'scale(0)';
                    nodeGroup.style.transformOrigin = `${position.x}px ${position.y}px`;
                    setTimeout(() => {
                        nodeGroup.style.transition = 'transform 0.5s ease-out';
                        nodeGroup.style.transform = 'scale(1)';
                    }, 100);
                }
                
                // Add the node to the SVG
                svg.appendChild(nodeGroup);
                
                // Add event listeners for dragging
                nodeGroup.addEventListener('mousedown', startDrag);
                nodeGroup.addEventListener('click', showNodeDetails);
                nodeGroup.addEventListener('mouseover', highlightDependencies);
                nodeGroup.addEventListener('mouseout', clearHighlights);
            });

            // Render connections
            step.connections.forEach(conn => {
                const fromNode = step.nodes.find(n => n.id === conn.from);
                const toNode = step.nodes.find(n => n.id === conn.to);
                
                if (!fromNode || !toNode) return;
                
                const fromPos = nodePositions[fromNode.id];
                const toPos = nodePositions[toNode.id];
                
                // Calculate path points
                const startX = fromPos.x + 60; // Right edge of source node
                const startY = fromPos.y;
                const endX = toPos.x - 60; // Left edge of target node
                const endY = toPos.y;
                const midX = (startX + endX) / 2;
                const midY = (startY + endY) / 2 - 30; // Curve upward
                
                // Create the path
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'connection');
                path.setAttribute('d', `M ${startX} ${startY} Q ${midX} ${midY} ${endX} ${endY}`);
                path.setAttribute('stroke', conn.color.replace('0.5', '1'));
                path.setAttribute('stroke-width', '3');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                path.setAttribute('data-from', conn.from);
                path.setAttribute('data-to', conn.to);
                
                // Create operation label background
                const labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                labelBg.setAttribute('x', midX - 25);
                labelBg.setAttribute('y', midY - 42);
                labelBg.setAttribute('width', '50');
                labelBg.setAttribute('height', '24');
                labelBg.setAttribute('rx', '10');
                labelBg.setAttribute('fill', conn.color.replace('0.5', '1'));
                
                // Create operation label text
                const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelText.setAttribute('x', midX);
                labelText.setAttribute('y', midY - 30);
                labelText.setAttribute('text-anchor', 'middle');
                labelText.setAttribute('dominant-baseline', 'central');
                labelText.setAttribute('font-size', '12px');
                labelText.setAttribute('font-weight', 'bold');
                labelText.setAttribute('fill', 'white');
                labelText.textContent = conn.operation + (conn.label ? ' ' + conn.label : '');
                
                // Add the connection elements to the SVG
                svg.appendChild(path);
                svg.appendChild(labelBg);
                svg.appendChild(labelText);
            });

            // Update the step iframe content
            updateStepIframe(step, stepIndex);
        }

        // Update the step iframe content
        function updateStepIframe(step, stepIndex) {
            const iframeDoc = stepIframe.contentDocument || stepIframe.contentWindow.document;
            iframeDoc.open();
            
            let content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0;
                            padding: 15px;
                        }
                        .step-content {
                            padding: 15px;
                            background-color: #FFF3CD;
                            border-left: 3px solid #FFC107;
                            margin-bottom: 10px;
                        }
                        .final-answer {
                            background-color: #d4edda;
                            border-left: 3px solid #28a745;
                            padding: 10px 15px;
                            margin-top: 15px;
                            border-radius: 4px;
                        }
                    </style>
                </head>
                <body>
                    <div class="step-content">
                        <strong>Step ${stepIndex}:</strong> ${step.explanation}<br>
                        <strong>Calculation:</strong> ${step.calculation}
                    </div>
            `;
            
            // Add final answer box if this is the last step
            if (stepIndex === problemData.totalSteps) {
                content += `
                    <div class="final-answer">
                        <strong>Final Answer:</strong> In one semester, Kimo spends 272 hours attending classes.
                    </div>
                `;
            }
            
            content += `
                </body>
                </html>
            `;
            
            iframeDoc.write(content);
            iframeDoc.close();
        }

        // Event handler for starting node drag
        function startDrag(event) {
            event.preventDefault();
            draggedNode = event.currentTarget;
            const nodeId = draggedNode.id;
            const rect = draggedNode.querySelector('rect');
            const rectX = parseFloat(rect.getAttribute('x'));
            const rectY = parseFloat(rect.getAttribute('y'));
            
            // Calculate offset
            dragOffset.x = event.clientX - (rectX + 60);
            dragOffset.y = event.clientY - (rectY + 35);
            
            // Add event listeners for dragging
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
        }

        // Event handler for dragging a node
        function drag(event) {
            if (!draggedNode) return;
            
            const nodeId = draggedNode.id;
            const newX = event.clientX - dragOffset.x;
            const newY = event.clientY - dragOffset.y;
            
            // Update node position
            nodePositions[nodeId] = { x: newX, y: newY };
            
            // Re-render the current step
            renderStep(currentStep);
        }

        // Event handler for ending node drag
        function endDrag() {
            draggedNode = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
        }

        // Event handler for showing node details
        function showNodeDetails(event) {
            // Prevent triggering when dragging
            if (draggedNode) return;
            
            const nodeId = event.currentTarget.id;
            const step = problemData.getSteps()[currentStep - 1];
            const node = step.nodes.find(n => n.id === nodeId);
            
            if (node) {
                alert(`${node.label}\nValue: ${node.value}\nCalculation: ${node.calc}`);
            }
        }

        // Event handler for highlighting dependencies
        function highlightDependencies(event) {
            const nodeId = event.currentTarget.id;
            const step = problemData.getSteps()[currentStep - 1];
            
            // Highlight the node
            event.currentTarget.classList.add('highlight');
            
            // Highlight incoming connections
            const incomingConns = step.connections.filter(conn => conn.to === nodeId);
            incomingConns.forEach(conn => {
                const path = svg.querySelector(`path[data-from="${conn.from}"][data-to="${conn.to}"]`);
                if (path) path.classList.add('highlight');
                
                // Highlight source nodes
                const sourceNode = svg.getElementById(conn.from);
                if (sourceNode) sourceNode.classList.add('highlight');
            });
            
            // Highlight outgoing connections
            const outgoingConns = step.connections.filter(conn => conn.from === nodeId);
            outgoingConns.forEach(conn => {
                const path = svg.querySelector(`path[data-from="${conn.from}"][data-to="${conn.to}"]`);
                if (path) path.classList.add('highlight');
                
                // Highlight target nodes
                const targetNode = svg.getElementById(conn.to);
                if (targetNode) targetNode.classList.add('highlight');
            });
        }

        // Event handler for clearing highlights
        function clearHighlights() {
            // Clear node highlights
            const highlightedNodes = svg.querySelectorAll('.node.highlight');
            highlightedNodes.forEach(node => node.classList.remove('highlight'));
            
            // Clear connection highlights
            const highlightedConns = svg.querySelectorAll('.connection.highlight');
            highlightedConns.forEach(conn => conn.classList.remove('highlight'));
        }

        // Event handler for play/pause button
        function togglePlayPause() {
            isPlaying = !isPlaying;
            playPauseBtn.textContent = isPlaying ? 'Pause' : 'Play';
            
            if (isPlaying) {
                // Start auto-play
                playInterval = setInterval(() => {
                    if (currentStep < problemData.totalSteps) {
                        currentStep++;
                        renderStep(currentStep);
                        updateButtons();
                    } else {
                        // Stop at the end
                        isPlaying = false;
                        playPauseBtn.textContent = 'Play';
                        clearInterval(playInterval);
                    }
                }, 3000);
            } else {
                // Stop auto-play
                clearInterval(playInterval);
            }
        }

        // Event handler for stop button
        function stopAnimation() {
            isPlaying = false;
            playPauseBtn.textContent = 'Play';
            clearInterval(playInterval);
            currentStep = 1;
            renderStep(currentStep);
            updateButtons();
        }

        // Event handler for previous button
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                renderStep(currentStep);
                updateButtons();
            }
        }

        // Event handler for next button
        function nextStep() {
            if (currentStep < problemData.totalSteps) {
                currentStep++;
                renderStep(currentStep);
                updateButtons();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            playPauseBtn.addEventListener('click', togglePlayPause);
            stopBtn.addEventListener('click', stopAnimation);
            prevBtn.addEventListener('click', previousStep);
            nextBtn.addEventListener('click', nextStep);
        }

        // Initialize the visualization
        init();
    </script>
</body>
</html>